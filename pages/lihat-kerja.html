<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>Lihat Jadwal Kerja</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="mobile-web-app-capable" content="yes">
<style>
@import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap');

* {
  box-sizing: border-box;
  margin: 0;
  padding: 0;
}

html, body {
  overscroll-behavior: none;
  overflow-x: hidden;
  -webkit-overflow-scrolling: touch;
  width: 100%;
}

body {
  font-family: 'Poppins', sans-serif;
  background: linear-gradient(135deg, #f7f9ff, #eef3ff);
  color: #2b2f4b;
  min-height: 100vh;
  padding: 3vw;
  padding-top: max(3vw, env(safe-area-inset-top));
  padding-bottom: max(18vw, env(safe-area-inset-bottom) + 15vw);
  padding-left: max(3vw, env(safe-area-inset-left));
  padding-right: max(3vw, env(safe-area-inset-right));
}

.header {
  text-align: center;
  margin-bottom: 4vw;
}

.header h1 {
  font-size: 5vw;
  font-weight: bold;
  color: #333;
  text-shadow: 0 0.3vw 0.5vw rgba(255,255,255,0.9), 
               0 0.2vw 0.4vw rgba(0,0,0,0.3);
  margin-bottom: 2vw;
}

.header-info {
  font-size: 3.5vw;
  color: #666;
  font-weight: 600;
}

/* Edit Mode Panel */
.edit-mode-panel {
  display: none;
  gap: 1.5vw;
  justify-content: center;
  margin-bottom: 3vw;
  flex-wrap: wrap;
}

.edit-mode-panel.active {
  display: flex;
}

.btn-edit-mode {
  flex: 1;
  min-width: 28%;
  padding: 2.5vw 1vw;
  font-size: 3vw;
  color: white;
  border: none;
  border-radius: 1.5vw;
  cursor: pointer;
  box-shadow: 0 0.5vw 1vw rgba(0,0,0,0.2);
  transition: all 0.3s;
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 0.5vw;
  position: relative;
}

.btn-edit-mode .icon {
  font-size: 4vw;
}

.btn-edit-mode .label {
  font-size: 2.5vw;
  font-weight: bold;
}

.btn-edit-mode.active {
  transform: scale(1.05);
  box-shadow: 0 0 2vw rgba(255,255,255,0.8);
}

.btn-edit-mode:not(.active) {
  opacity: 0.5;
  transform: scale(0.9);
}

.btn-mode-psm {
  background: linear-gradient(to bottom, #6c5ce7 0%, #5f3dc4 50%, #4c2a85 100%);
}

.btn-mode-lengkap {
  background: linear-gradient(to bottom, #00b894 0%, #00a085 50%, #00695c 100%);
}

.btn-mode-p-sm {
  background: linear-gradient(to bottom, #fdcb6e 0%, #f39c12 50%, #e67e22 100%);
}

/* Edit Info Banner */
.edit-info {
  display: none;
  background: #fff3cd;
  padding: 3vw;
  border-radius: 1.5vw;
  margin-bottom: 3vw;
  color: #856404;
  text-align: center;
  font-size: 3.5vw;
  font-weight: bold;
  box-shadow: 0 0.5vw 1vw rgba(0,0,0,0.1);
}

.edit-info.active {
  display: block;
}

/* Table Container */
.table-container {
  overflow-x: auto;
  background: white;
  border-radius: 2vw;
  box-shadow: 0 1vw 3vw rgba(0,0,0,0.1);
  -webkit-overflow-scrolling: touch;
  margin-bottom: 4vw;
}

table {
  border-collapse: collapse;
  width: 100%;
}

th, td {
  border: 2px solid #999;
  padding: 2vw 1.5vw;
  text-align: center;
  font-size: 3.5vw;
}

th {
  background: #4a90d9;
  color: white;
  position: sticky;
  top: 0;
  z-index: 10;
  font-weight: 600;
}

.header-judul {
  background: #2c5282;
  font-size: 4vw;
  font-weight: bold;
}

.header-unit {
  background: #3d6ba8;
}

.col-no {
  width: 8vw;
  min-width: 8vw;
}

.col-nama {
  width: 35vw;
  text-align: left;
  min-width: 35vw;
  max-width: 35vw;
  word-wrap: break-word;
  font-size: 3vw;
  padding: 0 !important;
}

/* Sticky untuk header (th) */
th.col-no {
  position: sticky;
  left: 0;
  z-index: 15;
  background: #4a90d9;
}

th.col-nama {
  position: sticky;
  left: 8vw;
  z-index: 15;
  background: #4a90d9;
}

/* Sticky untuk data (td) */
td.col-no {
  position: sticky;
  left: 0;
  z-index: 5;
  background: #f0f0f0;
}

td.col-nama {
  position: sticky;
  left: 8vw;
  z-index: 5;
  background: #f0f0f0;
}

tr {
  height: 12vw;
}

.col-jadwal {
  width: 12vw;
  min-width: 12vw;
}

.weekend {
  background: #ffcccc !important;
}

.weekend-header {
  background: #d94444 !important;
}

/* Edit mode dropdown */
.table-container.edit-mode td select {
  padding: 1vw 0;
  font-size: 3vw;
  width: 95%;
  text-align: center;
  border: 1px solid #ccc;
  border-radius: 0.5vw;
  background: white;
}

/* Nama Cell with Tracking */
.nama-cell-content {
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 2vw;
  width: 100%;
  height: 100%;
  padding: 2vw 1.5vw;
}

.nama-text {
  font-weight: bold;
  font-size: 3.2vw;
  flex: 1;
  line-height: 1.2;
  overflow: hidden;
  text-overflow: ellipsis;
}

/* Buttons */
.actions {
  display: flex;
  gap: 2vw;
  justify-content: center;
  flex-wrap: wrap;
  margin-bottom: 3vw;
}

.btn {
  padding: 3.5vw 5vw;
  font-size: 4vw;
  border: none;
  border-radius: 1.5vw;
  cursor: pointer;
  font-weight: 600;
  box-shadow: 0 0.5vw 1vw rgba(0,0,0,0.2);
  transition: all 0.2s;
  font-family: 'Poppins', sans-serif;
}

.btn:active {
  transform: scale(0.98);
}

.btn-primary {
  background: linear-gradient(to bottom, #3399ff 0%, #007bff 50%, #0056b3 100%);
  color: white;
}

.btn-success {
  background: linear-gradient(to bottom, #5cb85c 0%, #28a745 50%, #1e7e34 100%);
  color: white;
}

.btn-secondary {
  background: linear-gradient(to bottom, #868e96 0%, #6c757d 50%, #545b62 100%);
  color: white;
}

.btn-back {
  position: fixed !important;
  bottom: max(4vw, env(safe-area-inset-bottom) + 2vw) !important;
  left: max(3vw, env(safe-area-inset-left)) !important;
  z-index: 1000;
  background: linear-gradient(to bottom, #868e96 0%, #6c757d 50%, #545b62 100%);
  color: white;
  padding: 2.5vw 4vw !important;
  font-size: 3.5vw;
  border-radius: 2vw;
  box-shadow: 0 1vw 2vw rgba(0,0,0,0.3);
}

/* Floating Buttons (Undo/Redo) */
.floating-buttons {
  position: fixed;
  left: max(2vw, env(safe-area-inset-left));
  top: 50%;
  transform: translateY(-50%);
  display: none;
  flex-direction: column;
  gap: 2vw;
  z-index: 100;
}

.floating-buttons.active {
  display: flex;
}

.btn-float {
  width: 12vw;
  height: 12vw;
  border-radius: 50%;
  border: none;
  font-size: 5vw;
  cursor: pointer;
  box-shadow: 0 0.8vw 1.5vw rgba(0,0,0,0.3);
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.2s;
}

.btn-float:active {
  transform: scale(0.95);
}

.btn-float:disabled {
  opacity: 0.3;
  cursor: not-allowed;
}

.btn-undo {
  background: linear-gradient(to bottom, #ffda6a 0%, #ffc107 50%, #d9a406 100%);
  color: #333;
}

.btn-redo {
  background: linear-gradient(to bottom, #3dc5d8 0%, #17a2b8 50%, #138496 100%);
  color: white;
}

/* Save Indicator */
.save-indicator {
  position: fixed;
  bottom: max(15vw, env(safe-area-inset-bottom) + 12vw);
  right: max(3vw, env(safe-area-inset-right));
  background: rgba(0, 0, 0, 0.8);
  color: white;
  padding: 2vw 4vw;
  border-radius: 2vw;
  font-size: 3vw;
  z-index: 9999;
  display: none;
  box-shadow: 0 0.5vw 1.5vw rgba(0,0,0,0.4);
  animation: fadeIn 0.3s ease;
}

.save-indicator.active {
  display: block;
}

@keyframes fadeIn {
  from {
    opacity: 0;
    transform: translateY(10px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

/* Loading */
.loading {
  text-align: center;
  padding: 10vw;
  color: #666;
  font-size: 4vw;
}

.hidden {
  display: none !important;
}
</style>
</head>
<body>

<div class="header">
  <h1 id="pageTitle">üìã Jadwal Pelaksanaan Kerja</h1>
  <div class="header-info">
    <span id="infoUnit"></span> ‚Ä¢ <span id="infoBulan"></span>
  </div>
</div>

<!-- Edit Info Banner -->
<div class="edit-info" id="editInfo">
  <strong>MODE EDIT</strong> - Perubahan otomatis tersimpan
</div>

<!-- Edit Mode Panel -->
<div class="edit-mode-panel" id="editModePanel">
  <button class="btn-edit-mode btn-mode-psm" data-mode="PSM" onclick="setEditMode('PSM')">
    <span class="icon">üë•</span>
    <span class="label">Mode P, S, M</span>
  </button>
  <button class="btn-edit-mode btn-mode-lengkap active" data-mode="LENGKAP" onclick="setEditMode('LENGKAP')">
    <span class="icon">üìã</span>
    <span class="label">Mode Lengkap</span>
  </button>
  <button class="btn-edit-mode btn-mode-p-sm" data-mode="P_SM" onclick="setEditMode('P_SM')">
    <span class="icon">üîÄ</span>
    <span class="label">Mode P, SM</span>
  </button>
</div>

<!-- Table Container -->
<div class="table-container" id="tableContainer">
  <div class="loading">Memuat jadwal...</div>
</div>

<!-- Action Buttons -->
<div class="actions" id="viewActions">
  <button class="btn btn-primary" onclick="toggleEditMode()">‚úèÔ∏è EDIT JADWAL</button>
</div>

<div class="actions hidden" id="editActions">
  <button class="btn btn-success" onclick="saveChanges()">üíæ SIMPAN</button>
  <button class="btn btn-secondary" onclick="cancelEdit()">‚ùå BATAL</button>
</div>

<!-- Floating Buttons -->
<div class="floating-buttons" id="floatingButtons">
  <button class="btn-float btn-undo" id="btnUndo" onclick="undoChange()" disabled>‚Ü©</button>
  <button class="btn-float btn-redo" id="btnRedo" onclick="redoChange()" disabled>‚Ü™</button>
</div>

<!-- Back Button -->
<button class="btn-back" onclick="backToSelection()">‚Üê KEMBALI</button>

<!-- Save Indicator -->
<div class="save-indicator" id="saveIndicator"></div>

<script>
// API Configuration
const API_URL = 'https://script.google.com/macros/s/AKfycbwgHWP4PcL8oYMlDFUpPv6RfJrHoQythO9DxHzNZ1afPaz_HRnNThKHS_n4tsZe59LA/exec';

// Shift Options
const WEEKDAY_SHIFT_OPTIONS = ['', 'P', 'S', 'M', 'SM', 'OFF', 'CUTI'];
const WEEKEND_SHIFT_OPTIONS = ['', 'P12', 'M12', 'OFF', 'CUTI'];
const EDIT_MODE_PSM_OPTIONS = ['', 'P', 'S', 'M', 'OFF', 'CUTI'];
const EDIT_MODE_P_SM_OPTIONS = ['', 'P', 'SM', 'OFF', 'CUTI'];

// Global Variables
let currentUnit = '';
let currentBulan = '';
let currentPassword = '';
let currentData = null;
let originalData = null;
let isEditMode = false;
let currentEditMode = 'LENGKAP';
let undoStack = [];
let redoStack = [];
let editedData = {};
let saveIndicatorTimeout = null;

// Initialize
window.addEventListener('DOMContentLoaded', init);

function init() {
  // Get parameters from URL
  const params = new URLSearchParams(window.location.search);
  currentUnit = params.get('unit');
  currentBulan = params.get('bulan');
  currentPassword = params.get('password');
  
  if (!currentUnit || !currentBulan || !currentPassword) {
    alert('Parameter tidak lengkap. Kembali ke halaman pemilihan.');
    window.location.href = 'jadwal-kerja.html';
    return;
  }
  
  // Set header info
  document.getElementById('infoUnit').textContent = currentUnit;
  document.getElementById('infoBulan').textContent = formatBulan(currentBulan);
  
  // Load data
  loadJadwal();
}

function formatBulan(code) {
  const monthNames = ['Januari', 'Februari', 'Maret', 'April', 'Mei', 'Juni',
                      'Juli', 'Agustus', 'September', 'Oktober', 'November', 'Desember'];
  const month = parseInt(code.substring(0, 2));
  const year = '20' + code.substring(2, 4);
  return monthNames[month - 1] + ' ' + year;
}

async function loadJadwal() {
  try {
    showSaveIndicator('üìä Memuat jadwal...', 3000);
    
    const url = `${API_URL}?action=getJadwalPelaksanaan&unit=${encodeURIComponent(currentUnit)}&bulan=${currentBulan}&password=${encodeURIComponent(currentPassword)}`;
    const response = await fetch(url);
    const result = await response.json();
    
    if (result.success) {
      currentData = result.data;
      originalData = JSON.parse(JSON.stringify(currentData));
      renderTable(false);
      document.getElementById('viewActions').classList.remove('hidden');
    } else {
      alert('Gagal memuat jadwal: ' + result.message);
      window.location.href = 'jadwal-kerja.html';
    }
  } catch (error) {
    console.error('Error loading jadwal:', error);
    alert('Terjadi kesalahan saat memuat jadwal');
  }
}

function renderTable(editMode) {
  if (!currentData) return;
  
  const data = currentData;
  const weekendDays = ['SAB', 'MIN'];
  
  let html = '<table>';
  
  // Header: Judul bulan
  html += `<tr><th class="header-judul" colspan="${data.header.tanggal.length + 2}">${data.header.judul || data.bulan}</th></tr>`;
  
  // Header: Unit + Hari
  html += '<tr class="header-unit">';
  html += `<th class="col-no">${data.unit}</th>`;
  html += `<th class="col-nama">HARI</th>`;
  data.header.hari.forEach((h, i) => {
    const isWeekend = weekendDays.includes(h);
    html += `<th class="col-jadwal ${isWeekend ? 'weekend-header' : ''}">${h}</th>`;
  });
  html += '</tr>';
  
  // Header: NO + NAMA + Tanggal
  html += '<tr>';
  html += '<th class="col-no">NO</th><th class="col-nama">NAMA</th>';
  data.header.tanggal.forEach((t, i) => {
    const isWeekend = weekendDays.includes(data.header.hari[i]);
    html += `<th class="col-jadwal ${isWeekend ? 'weekend-header' : ''}">${t}</th>`;
  });
  html += '</tr>';
  
  // Data Personil
  data.personil.forEach((p, pIdx) => {
    html += '<tr>';
    html += `<td class="col-no">${p.no}</td>`;
    html += `<td class="col-nama">
      <div class="nama-cell-content">
        <div class="nama-text">${p.nama}</div>
      </div>
    </td>`;
    
    p.shifts.forEach((shift, jIdx) => {
      const isWeekend = weekendDays.includes(data.header.hari[jIdx]);
      const currentValue = getEditedValue(pIdx, jIdx, shift);
      
      if (editMode) {
        // Tentukan opsi dropdown
        let options;
        if (isWeekend) {
          options = WEEKEND_SHIFT_OPTIONS;
        } else {
          switch (currentEditMode) {
            case 'PSM':
              options = EDIT_MODE_PSM_OPTIONS;
              break;
            case 'P_SM':
              options = EDIT_MODE_P_SM_OPTIONS;
              break;
            case 'LENGKAP':
            default:
              options = WEEKDAY_SHIFT_OPTIONS;
              break;
          }
        }
        
        // Pastikan currentValue ada di options
        if (currentValue && !options.includes(currentValue)) {
          options = ['', currentValue, ...options.slice(1)];
        }
        
        html += `<td class="col-jadwal ${isWeekend ? 'weekend' : ''}">
          <select data-p="${pIdx}" data-j="${jIdx}" onchange="onDropdownChange(${pIdx}, ${jIdx}, this.value)">
            ${options.map(o => `<option value="${o}" ${currentValue === o ? 'selected' : ''}>${o}</option>`).join('')}
          </select>
        </td>`;
      } else {
        html += `<td class="col-jadwal ${isWeekend ? 'weekend' : ''}">${currentValue}</td>`;
      }
    });
    
    html += '</tr>';
  });
  
  html += '</table>';
  
  const container = document.getElementById('tableContainer');
  container.innerHTML = html;
  
  if (editMode) {
    container.classList.add('edit-mode');
  } else {
    container.classList.remove('edit-mode');
  }
}

function getEditKey(pIdx, jIdx) {
  return `${currentUnit}_${currentBulan}_${pIdx}_${jIdx}`;
}

function getEditedValue(pIdx, jIdx, originalValue) {
  const key = getEditKey(pIdx, jIdx);
  return editedData.hasOwnProperty(key) ? editedData[key] : originalValue;
}

function toggleEditMode() {
  isEditMode = true;
  currentEditMode = 'LENGKAP';
  
  document.getElementById('editInfo').classList.add('active');
  document.getElementById('editModePanel').classList.add('active');
  document.getElementById('viewActions').classList.add('hidden');
  document.getElementById('editActions').classList.remove('hidden');
  document.getElementById('floatingButtons').classList.add('active');
  
  renderTable(true);
  showSaveIndicator('‚úèÔ∏è Mode edit aktif', 2000);
}

function setEditMode(mode) {
  if (currentEditMode === mode) return;
  
  const modeNames = {
    'PSM': 'Mode P, S, M',
    'LENGKAP': 'Mode Lengkap',
    'P_SM': 'Mode P, SM'
  };
  
  if (confirm(`Ganti ke ${modeNames[mode]}?`)) {
    currentEditMode = mode;
    
    document.querySelectorAll('.btn-edit-mode').forEach(btn => btn.classList.remove('active'));
    document.querySelector(`.btn-edit-mode[data-mode="${mode}"]`)?.classList.add('active');
    
    renderTable(true);
    showSaveIndicator(`‚úì ${modeNames[mode]} aktif`, 2000);
  }
}

function onDropdownChange(pIdx, jIdx, value) {
  const key = getEditKey(pIdx, jIdx);
  const oldValue = editedData.hasOwnProperty(key) ? editedData[key] : currentData.personil[pIdx].shifts[jIdx];
  
  // Push to undo stack
  undoStack.push({ key, oldValue, newValue: value, pIdx, jIdx });
  redoStack = [];
  
  editedData[key] = value;
  updateUndoRedoButtons();
  autoSave(pIdx, jIdx, value);
}

async function autoSave(pIdx, jIdx, value) {
  try {
    showSaveIndicator('üíæ Menyimpan...', 1500);
    
    const url = API_URL;
    const params = new URLSearchParams({
      action: 'updateShift',
      unit: currentUnit,
      bulan: currentBulan,
      password: currentPassword,
      type: 'PEL',
      rowIndex: pIdx,
      colIndex: jIdx,
      value: value
    });
    
    const response = await fetch(url, {
      method: 'POST',
      body: params
    });
    
    const result = await response.json();
    
    if (result.success) {
      showSaveIndicator('‚úì Tersimpan', 1500);
    } else {
      showSaveIndicator('‚ùå Gagal: ' + result.message, 3000);
    }
  } catch (error) {
    console.error('Auto-save error:', error);
    showSaveIndicator('‚ùå Error menyimpan', 2000);
  }
}

function undoChange() {
  if (undoStack.length === 0) return;
  
  const action = undoStack.pop();
  redoStack.push(action);
  
  editedData[action.key] = action.oldValue;
  
  const sel = document.querySelector(`select[data-p="${action.pIdx}"][data-j="${action.jIdx}"]`);
  if (sel) sel.value = action.oldValue;
  
  updateUndoRedoButtons();
  autoSave(action.pIdx, action.jIdx, action.oldValue);
}

function redoChange() {
  if (redoStack.length === 0) return;
  
  const action = redoStack.pop();
  undoStack.push(action);
  
  editedData[action.key] = action.newValue;
  
  const sel = document.querySelector(`select[data-p="${action.pIdx}"][data-j="${action.jIdx}"]`);
  if (sel) sel.value = action.newValue;
  
  updateUndoRedoButtons();
  autoSave(action.pIdx, action.jIdx, action.newValue);
}

function updateUndoRedoButtons() {
  document.getElementById('btnUndo').disabled = undoStack.length === 0;
  document.getElementById('btnRedo').disabled = redoStack.length === 0;
}

function saveChanges() {
  if (confirm('Semua perubahan sudah tersimpan otomatis. Yakin ingin keluar dari mode edit?')) {
    exitEditMode();
  }
}

function cancelEdit() {
  if (confirm('Yakin ingin membatalkan semua perubahan?')) {
    // Reset data
    currentData = JSON.parse(JSON.stringify(originalData));
    editedData = {};
    undoStack = [];
    redoStack = [];
    
    exitEditMode();
    showSaveIndicator('‚úì Perubahan dibatalkan', 2000);
  }
}

function exitEditMode() {
  isEditMode = false;
  currentEditMode = 'LENGKAP';
  
  document.getElementById('editInfo').classList.remove('active');
  document.getElementById('editModePanel').classList.remove('active');
  document.getElementById('viewActions').classList.remove('hidden');
  document.getElementById('editActions').classList.add('hidden');
  document.getElementById('floatingButtons').classList.remove('active');
  
  renderTable(false);
}

function backToSelection() {
  if (isEditMode) {
    if (confirm('Anda sedang dalam mode edit. Yakin ingin kembali?')) {
      window.location.href = 'jadwal-kerja.html';
    }
  } else {
    window.location.href = 'jadwal-kerja.html';
  }
}

function showSaveIndicator(message, duration = 2000) {
  const indicator = document.getElementById('saveIndicator');
  indicator.textContent = message;
  indicator.classList.add('active');
  
  if (saveIndicatorTimeout) clearTimeout(saveIndicatorTimeout);
  
  saveIndicatorTimeout = setTimeout(() => {
    indicator.classList.remove('active');
  }, duration);
}
</script>

</body>
</html>
